name: PR Build Check

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'build-scripts/**'
      - 'VERSION'
      - '.github/workflows/**'

jobs:
  check-versions:
    name: Validate VERSION file
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate VERSION file format
        run: |
          echo "Checking VERSION file format..."

          if ! grep -q '^LIBZMQ_VERSION=' VERSION; then
            echo "❌ LIBZMQ_VERSION not found in VERSION file"
            exit 1
          fi

          if ! grep -q '^LIBSODIUM_VERSION=' VERSION; then
            echo "❌ LIBSODIUM_VERSION not found in VERSION file"
            exit 1
          fi

          LIBZMQ_VERSION=$(grep '^LIBZMQ_VERSION=' VERSION | cut -d'=' -f2)
          LIBSODIUM_VERSION=$(grep '^LIBSODIUM_VERSION=' VERSION | cut -d'=' -f2)

          echo "✅ VERSION file is valid"
          echo "  - libzmq: ${LIBZMQ_VERSION}"
          echo "  - libsodium: ${LIBSODIUM_VERSION}"

  build-sample:
    name: Build Sample Platform (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - platform: windows-x64
            os: windows-latest
          - platform: linux-x64
            os: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read versions
        id: versions
        shell: bash
        run: |
          LIBZMQ_VERSION=$(grep '^LIBZMQ_VERSION=' VERSION | cut -d'=' -f2)
          LIBSODIUM_VERSION=$(grep '^LIBSODIUM_VERSION=' VERSION | cut -d'=' -f2)
          echo "libzmq_version=${LIBZMQ_VERSION}" >> $GITHUB_OUTPUT
          echo "libsodium_version=${LIBSODIUM_VERSION}" >> $GITHUB_OUTPUT

      - name: Install Linux dependencies
        if: matrix.platform == 'linux-x64'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git pkg-config libtool autoconf automake

      - name: Build (Windows)
        if: matrix.platform == 'windows-x64'
        shell: pwsh
        run: |
          .\build-scripts\windows\build.ps1 `
            -LibzmqVersion "${{ steps.versions.outputs.libzmq_version }}" `
            -LibsodiumVersion "${{ steps.versions.outputs.libsodium_version }}"

      - name: Build (Linux)
        if: matrix.platform == 'linux-x64'
        run: |
          chmod +x ./build-scripts/linux/build.sh
          ./build-scripts/linux/build.sh \
            "${{ steps.versions.outputs.libzmq_version }}" \
            "${{ steps.versions.outputs.libsodium_version }}"

      - name: Verify build artifacts
        shell: bash
        run: |
          platform_dir="dist/${{ matrix.platform }}"

          if [ ! -d "${platform_dir}" ]; then
            echo "❌ Build output directory not found: ${platform_dir}"
            exit 1
          fi

          echo "✅ Build completed successfully for ${{ matrix.platform }}"
          echo "Build artifacts:"
          find "${platform_dir}" -type f -ls

  pr-summary:
    name: PR Check Summary
    runs-on: ubuntu-latest
    needs:
      - check-versions
      - build-sample
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## PR Build Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.check-versions.result }}" == "success" ]; then
            echo "- ✅ VERSION file validation" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ VERSION file validation" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.build-sample.result }}" == "success" ]; then
            echo "- ✅ Sample platform builds" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Sample platform builds" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** This is a quick validation check. Full builds for all platforms will run after merge." >> $GITHUB_STEP_SUMMARY
